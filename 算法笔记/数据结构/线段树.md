# çº¿æ®µæ ‘æ¨¡æ¿
[ã€AgOHã®æ•°æ®ç»“æ„ã€‘çº¿æ®µæ ‘åˆ†è£‚åˆå¹¶_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1f54y1E7e6/)
çº¿æ®µæ ‘æ˜¯ä¸€ç§å¯ä»¥ç»´æŠ¤æ»¡è¶³ç»“åˆå¾‹çš„åŒºé—´ä¿¡æ¯çš„æ•°æ®ç»“æ„
![[Pasted image 20240225004219.png]]

[P3372 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 1 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3372)
[P3374 ã€æ¨¡æ¿ã€‘æ ‘çŠ¶æ•°ç»„ 1 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3374)
```cpp
#include <cstring>
#include <iostream>
#include <algorithm>
using namespace std;
#define N 100005
#define LL long long
#define lc u<<1
#define rc u<<1|1
LL w[N];
struct Tree{ //çº¿æ®µæ ‘
    LL l,r,sum,add;
}tr[N*4];

void pushup(LL u){ //ä¸Šä¼ 
    tr[u].sum=tr[lc].sum+tr[rc].sum;
}
void pushdown(LL u){ //ä¸‹ä¼ 
    if(tr[u].add){//lazyæ ‡è¯†ä¸ä¸ºé›¶
        //ä¸‹æ”¾ç»™ä¸¤ä¸ªå„¿å­
        tr[lc].sum+=tr[u].add*(tr[lc].r-tr[lc].l+1),
        tr[rc].sum+=tr[u].add*(tr[rc].r-tr[rc].l+1),
        tr[lc].add+=tr[u].add,
        tr[rc].add+=tr[u].add,
        //lazyè¡¨ç¤ºç½®é›¶
        tr[u].add=0;
    }
}
void build(LL u,LL l,LL r){ //å»ºæ ‘ï¼Œä¿¡æ¯éƒ½åœ¨å¶å­ç»“ç‚¹ä¸Š
    tr[u]={l,r,w[l],0};
    if(l==r) return;
    LL m=l+r>>1;
    build(lc,l,m);
    build(rc,m+1,r);
    pushup(u);
}
void updata(int u, int x, int k){//ç‚¹ä¿®æ”¹
    if (tr[u].l == x && tr[u].r == x){//å¶å­ç»“ç‚¹ä¿®æ”¹
        tr[u].sum+=k;
        return ;
    }
    int m= tr[u].l + tr[u].r >> 1;//éå¶å­ç»“ç‚¹åˆ™è£‚å¼€
    if (x<=m) updata(lc,x,k);
    if (x>m) updata(rc,x,k);
    tr[u].sum= tr[lc].sum + tr[rc].sum;
}

void change(LL u,LL l,LL r,LL k){ //åŒºä¿®
    if(l<=tr[u].l&&tr[u].r<=r){
        tr[u].sum+=(tr[u].r-tr[u].l+1)*k;
        tr[u].add+=k;
        return;
    }
    LL m=tr[u].l+tr[u].r>>1;
    pushdown(u);
    if(l<=m) change(lc,l,r,k);
    if(r>m) change(rc,l,r,k);
    pushup(u);
}
LL query(LL u,LL l,LL r){ //åŒºæŸ¥
    if(l<=tr[u].l && tr[u].r<=r) return tr[u].sum;
    LL m=tr[u].l+tr[u].r>>1;
    pushdown(u);
    LL sum=0;
    if(l<=m) sum+=query(lc,l,r);
    if(r>m) sum+=query(rc,l,r);
    return sum;
}
int main(){
    int n,m,op,x,y,k;
    cin>>n>>m;
    for(int i=1; i<=n; i ++) cin>>w[i];

    build(1,1,n);
    while(m--){
        cin>>op>>x>>y;
        if(op==2)cout<<query(1,x,y)<<endl;
        else cin>>k,change(1,x,y,k);
    }
    return 0;
}
```



####  **ä¾‹é¢˜ä¸€**
[Queue - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/CF91B)
é¢˜ç›®å¤§æ„ï¼š
ç»™å®š `n` ä¸ªæ­£æ•´æ•°$a_1â€¦_n$ã€‚éœ€è¦è¾“å‡ºä¸€ä¸ª `n` ä¸ªæ•°ï¼Œè®¾æ­¤æ—¶æ­£åœ¨å¤„ç†ç¬¬`i`ä¸ªæ•°ï¼š
    - è®¾ $a_j < a_i,j > i$ã€‚
    - åœ¨æ»¡è¶³ç¬¬ä¸€æ¡çš„åŸºç¡€ä¸Šä½¿`j-i-1`å°½å¯èƒ½å¤§ï¼Œæ­¤æ—¶` j - i - 1` å³ä¸ºç­”æ¡ˆã€‚
$2 \leq n \leq 10^5ï¼Œa_i \leq 10^9$, å¦‚æœå¯¹äºæŸä¸ª `i`ï¼Œä¸å­˜åœ¨ä»»ä½•ä¸€ä¸ª`j`æ»¡è¶³ $a_j < a_i$ä¸”$j > i$ï¼Œåˆ™è¾“å‡º `-1`ã€‚

**å³æ‰¾æœ€è¿œå°äº`a[i]`çš„å€¼çš„ä½ç½®**

```cpp
#include<iostream>
#include <queue>
#include <cstring>
#define ll long long
#define lc u<<1
#define rc u<<1|1
using namespace std;
const ll maxn=1e5+5;
ll w[maxn];
struct tree{
	ll l,r,minsum,add;
}tr[maxn*4];

void updata(ll u){//å‘ä¸Šä¿®æ”¹ç»´æŠ¤çº¿æ®µæ ‘
	tr[u].minsum=min(tr[lc].minsum,tr[rc].minsum);
} 
void build(ll u,ll l,ll r){//å»ºæ ‘
	tr[u]={l,r,w[l],0};
	if (l==r){
		return ;
	} 
	ll m=l+r>>1;
	build(lc,l,m);
	build(rc,m+1,r);
	updata(u);
}
ll diancha(ll u,ll k){//ç‚¹æŸ¥
	ll t=-1;
	if (tr[u].l==tr[u].r){
		if (tr[u].minsum<k){
			return tr[u].l;
		}
		return -1;
	}

	if (tr[u].minsum<k){
		if(tr[rc].minsum<k){//å› ä¸ºè¦æ‰¾å°äºkçš„æœ€è¿œå€¼ï¼Œæ‰€ä»¥å…ˆè€ƒè™‘å³è¾¹çš„
		//å³è¾¹çš„æœ€å°å€¼å°äºkåˆ™ä¸å¿…å†è€ƒè™‘å·¦è¾¹çš„
			t=max(t,diancha(rc,k));
		} else if (tr[lc].minsum<k){
			t=max(t,diancha(lc,k));
		}
	}
	
	return t;
}
int main (){
	int n;
	cin>>n;
	for (int i=1;i<=n;i++)
	{
		cin>>w[i];
	}
	build (1,1,n);
	
	for (int i=1;i<=n;i++)
	{
		ll t = diancha(1,w[i]);
		if (t<=i){
			cout<<"-1 ";
		}else {
			cout<<t-i-1<<" ";
		}
		
	}
	return 0;
} 
```


#### ä¾‹é¢˜å››
[P3373 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 2 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3373)
ä¸€ä¸ªçº¿æ®µæ ‘ä¸ŠåŒæ—¶è¿›è¡Œä¸¤ç§æ“ä½œåŒºé—´ä¹˜ä»¥åŠåŒºé—´åŠ 
**ä»£ç **ï¼š
```cpp
#include <bits/stdc++.h>

#define MAXN 100010
#define ll long long

using namespace std;

int n, m, mod;
int a[MAXN];

struct Segment_Tree {
	ll sum, add, mul;
	int l, r;
}s[MAXN * 4];

void update(int pos) {
	s[pos].sum = (s[pos << 1].sum + s[pos << 1 | 1].sum) % mod;
    return;
}

void pushdown(int pos) { //pushdownçš„ç»´æŠ¤
	s[pos << 1].sum = (s[pos << 1].sum * s[pos].mul + s[pos].add * (s[pos << 1].r - s[pos << 1].l + 1)) % mod;
	s[pos << 1 | 1].sum = (s[pos << 1 | 1].sum * s[pos].mul + s[pos].add * (s[pos << 1 | 1].r - s[pos << 1 | 1].l + 1)) % mod;
	
	s[pos << 1].mul = (s[pos << 1].mul * s[pos].mul) % mod;
	s[pos << 1 | 1].mul = (s[pos << 1 | 1].mul * s[pos].mul) % mod;
	
	s[pos << 1].add = (s[pos << 1].add * s[pos].mul + s[pos].add) % mod;
	s[pos << 1 | 1].add = (s[pos << 1 | 1].add * s[pos].mul + s[pos].add) % mod;
		
	s[pos].add = 0;
	s[pos].mul = 1;
	return; 
}

void build_tree(int pos, int l, int r) { //å»ºæ ‘
	s[pos].l = l;
	s[pos].r = r;
	s[pos].mul = 1;
	
	if (l == r) {
		s[pos].sum = a[l] % mod;
		return;
	}
	
	int mid = (l + r) >> 1;
	build_tree(pos << 1, l, mid);
	build_tree(pos << 1 | 1, mid + 1, r);
	update(pos);
	return;
}

void ChangeMul(int pos, int x, int y, int k,int t) { 
	if (x <= s[pos].l && s[pos].r <= y) {
		if (t==2){
			s[pos].add = (s[pos].add + k) % mod;
			s[pos].sum = (s[pos].sum + k * (s[pos].r - s[pos].l + 1)) % mod;
		}else if (t==1){
			s[pos].add = (s[pos].add * k) % mod;
			s[pos].mul = (s[pos].mul * k) % mod;
			s[pos].sum = (s[pos].sum * k) % mod;
		}
		
		return;
	}
	
	pushdown(pos);
	int mid = (s[pos].l + s[pos].r) >> 1;
	if (x <= mid) ChangeMul(pos << 1, x, y, k,t);
	if (y > mid) ChangeMul(pos << 1 | 1, x, y, k,t);
	update(pos);
	return;
}

ll AskRange(int pos, int x, int y) { //åŒºé—´è¯¢é—®
	if (x <= s[pos].l && s[pos].r <= y) {
		return s[pos].sum;
	}
	
	pushdown(pos);
	ll val = 0;
	int mid = (s[pos].l + s[pos].r) >> 1;
	if (x <= mid) val = (val + AskRange(pos << 1, x, y)) % mod;
	if (y > mid) val = (val + AskRange(pos << 1 | 1, x, y)) % mod;
	return val;
}

int main() {
	scanf("%d%d", &n, &mod);
	
	for (int i = 1; i <= n; i++) {
		scanf("%d", &a[i]);
	}
	
	build_tree(1, 1, n);
	cin>>m;
	for (int i = 1; i <= m; i++) {
		int opt, x, y;
		scanf("%d%d%d", &opt, &x, &y);
		if (opt == 3) {
			printf("%lld\n", AskRange(1, x, y));
		}else {
			int k;
			scanf("%d", &k);
			ChangeMul(1, x, y, k,opt);
		}
	}
    
	return 0;
}
```


####  ä¾‹é¢˜ä¸‰
[P3740 [HAOI2014] è´´æµ·æŠ¥ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3740)
ä¸éœ€è¦å»ºæ ‘çš„çº¿æ®µæ ‘ï¼Œæ¯ä¸€æ­¥å¤§æ“ä½œéƒ½æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸”æ ‘ä¸Šåªå­˜å‚¨å°‘é‡çš„ä¿¡æ¯ï¼Œåœ¨ä¸å»ºæ ‘çš„æƒ…å†µä¸‹å¯ä»¥èŠ‚çœå¾ˆå¤šç©ºé—´å¤æ‚åº¦

**è§£é¢˜æ€è·¯**ï¼š
 çº¿æ®µæ ‘ ç»´æŠ¤åŒºé—´æ˜¯å¦è¢«æŸ“è‰²ï¼šåŒºé—´ä¿®æ”¹æ²¡è¢«æŸ“è‰²çš„ç‚¹ï¼Œæ ‡è®°ï¼Œ`++ans`ï¼›å¦‚æœåŒºé—´çš„ç‚¹å…¨è¢«æŸ“è¿‡è‰²ï¼Œé‚£`ans`ä¸å˜ã€‚
 **æ³¨æ„**æ•°æ®çš„å¤„ç†é¡ºåºä¸è¾“å…¥é¡ºåºç›¸åã€‚å› ä¸ºæœ€åè¾“å…¥çš„åœ¨æœ€ä¸Šé¢ï¼Œä¸€å®šå¯ä»¥`ans++`ï¼Œæ‰€ä»¥å…ˆå¤„ç†ï¼Œä¹‹åå¤„ç†å…ˆè¾“å…¥çš„æ•°æ®ï¼Œå¦‚æœå®ƒéœ€è¦çš„åŒºé—´å·²ç»è¢«æ ‡è®°åˆ™è¡¨ç¤ºå®ƒè¢«åè¾“å…¥çš„è¦†ç›–äº†ï¼Œäºæ˜¯ä¸èƒ½`ans++`ï¼Œç›´æ¥`return`ã€‚å¯ä»¥ç»“åˆä»£ç åœ¨ä»”ç»†ç†è§£

**ä»£ç **ï¼š
```cpp
#include <iostream>
#include <algorithm>
#include <cstring>
#include <set>
#define ll long long
#define lc u<<1
#define rc u<<1|1 
using namespace std;
const int maxn=1e7+5;
bool vis[maxn<<2];
bool flag;
int read()
{
    int now=0;char c=getchar();
    while(c<'0'||c>'9')c=getchar();
    while(c>='0'&&c<='9')now=(now<<3)+(now<<1)+c-'0',c=getchar();
    return now;
}
void updata(int u){
	vis[u]=vis[lc]&&vis[rc];
}
void Modify(int u,int l,int r,int L,int R){
	if (vis[u]){
		return ;
	}
	if (L<=l&&R>=r){
		flag=true;
		vis[u]=true;
		return ;
	}
	int m=(l+r)>>1;
	if (L<=m){
		Modify(lc,l,m,L,R);
	}
	if (R>m){
		Modify(rc,m+1,r,L,R);
	}
	updata(u);
	return ;
} 
int main ()
{
	int n,m;
	cin>>n>>m;
	int a[1005],b[1005];
	for (int i=m;i>=1;i--){
		cin>>a[i]>>b[i];
	}
	int ans=0;
	for (int i=1;i<=m;i++){
		flag=false;
		Modify(1,1,n,a[i],b[i]);
		if (flag){
			ans++;
		}
	}
	cout<<ans<<endl;
	return 0;
}
```

# çº¿æ®µæ ‘åˆ†è£‚åˆå¹¶

[P4556 [Vaniæœ‰çº¦ä¼š]é›¨å¤©çš„å°¾å·´ /ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘åˆå¹¶_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1f54y1E7e6/?p=3)
#### ä¾‹é¢˜
[P5494 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘åˆ†è£‚ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P5494)

**é¢˜æ„æè¿°**ï¼š
ç»™å‡ºä¸€ä¸ªå¯é‡é›†Â ğ‘ï¼ˆç¼–å·ä¸ºÂ 1ï¼‰ï¼Œå®ƒæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

`0 p x y`ï¼šå°†å¯é‡é›†Â ğ‘Â ä¸­å¤§äºç­‰äºÂ ğ‘¥ä¸”å°äºç­‰äºÂ ğ‘¦Â çš„å€¼ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„å¯é‡é›†ä¸­ï¼ˆæ–°å¯é‡é›†ç¼–å·ä¸ºä»Â 2Â å¼€å§‹çš„æ­£æ•´æ•°ï¼Œæ˜¯ä¸Šä¸€æ¬¡äº§ç”Ÿçš„æ–°å¯é‡é›†çš„ç¼–å·+1ï¼‰ã€‚

`1 p t`ï¼šå°†å¯é‡é›†Â ğ‘¡tÂ ä¸­çš„æ•°æ”¾å…¥å¯é‡é›†Â ğ‘ï¼Œä¸”æ¸…ç©ºå¯é‡é›†Â ğ‘¡ï¼ˆæ•°æ®ä¿è¯åœ¨æ­¤åçš„æ“ä½œä¸­ä¸ä¼šå‡ºç°å¯é‡é›†Â ğ‘¡ï¼‰ã€‚

`2 p x q`ï¼šåœ¨Â ğ‘è¿™ä¸ªå¯é‡é›†ä¸­åŠ å…¥Â ğ‘¥Â ä¸ªæ•°å­—Â ğ‘ã€‚//ä¹Ÿå°±æ˜¯r=l=qï¼Œval+=xï¼›

`3 p x y`ï¼šæŸ¥è¯¢å¯é‡é›†Â ğ‘Â ä¸­å¤§äºç­‰äºÂ ğ‘¥xÂ ä¸”å°äºç­‰äºÂ ğ‘¦Â çš„å€¼çš„ä¸ªæ•°ã€‚

`4 p k`ï¼šæŸ¥è¯¢åœ¨Â ğ‘Â è¿™ä¸ªå¯é‡é›†ä¸­ç¬¬Â ğ‘˜Â å°çš„æ•°ï¼Œä¸å­˜åœ¨æ—¶è¾“å‡ºÂ `-1`ã€‚

**è¾“å…¥æ ¼å¼**

ç¬¬ä¸€è¡Œä¸¤ä¸ªæ•´æ•°Â ğ‘›,ğ‘šn,mï¼Œè¡¨ç¤ºå¯é‡é›†ä¸­çš„æ•°åœ¨Â 1âˆ¼ğ‘›1âˆ¼nÂ çš„èŒƒå›´å†…ï¼Œæœ‰Â ğ‘šmÂ ä¸ªæ“ä½œã€‚

æ¥ä¸‹æ¥ä¸€è¡ŒÂ ğ‘›nÂ ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºÂ 1âˆ¼ğ‘›1âˆ¼nÂ è¿™äº›æ•°åœ¨Â ğ‘aÂ ä¸­å‡ºç°çš„æ¬¡æ•°Â (ğ‘ğ‘–â‰¤ğ‘š)(aiâ€‹â‰¤m)ã€‚

æ¥ä¸‹æ¥çš„Â ğ‘šmÂ è¡Œæ¯è¡Œè‹¥å¹²ä¸ªæ•´æ•°ï¼Œç¬¬ä¸€ä¸ªæ•°ä¸ºæ“ä½œçš„ç¼–å·Â ğ‘œğ‘ğ‘¡optï¼ˆ0â‰¤ğ‘œğ‘ğ‘¡â‰¤40â‰¤optâ‰¤4ï¼‰ï¼Œä»¥**é¢˜ç›®æè¿°**ä¸ºå‡†ã€‚

**è¾“å‡ºæ ¼å¼**

ä¾æ¬¡è¾“å‡ºæ¯ä¸ªæŸ¥è¯¢æ“ä½œçš„ç­”æ¡ˆã€‚

```cpp
#include <iostream>
#include <cstdio>
#include <ctime>
using namespace std;
//==========================================
const int maxn = 2e5 + 5;
typedef long long ll;
struct Node
{
    int l,r;//è¡¨ç¤ºå·¦å³åŒºé—´
    ll val;//è¡¨ç¤ºå…ƒç´ ä¸ªæ•°
}sgt[maxn*40];      //? 40 = 2*maxm*log2(maxn)ï¼Œç›¸å½“äºä¸€ä¸ªè¶…å¤§çš„çº¿æ®µæ ‘ï¼Œå¯æ‹†åˆ†
int cnt,root[maxn];//æŒ‡å‘çº¿æ®µæ ‘çš„æ ¹ï¼Œè¡¨ç¤ºä¸ºä¸€ä¸ªæ–°çš„çº¿æ®µæ ‘

inline void pushup(int k) { sgt[k].val = sgt[sgt[k].l].val + sgt[sgt[k].r].val; }
void modify(int l,int r,int &k,int p,int x)     // å•ç‚¹ä¿®æ”¹:pä½ç½®çš„å€¼åŠ ä¸Šxï¼Œç©ºé—´å¤æ‚åº¦O(logn)
{
    if(!k) k=++cnt;     // å¦‚æœåˆ°äº†NILç»“ç‚¹å°±æ–°å»ºä¸€ä¸ª
    sgt[k].val += x;    // å•ç‚¹ä¿®æ”¹çš„åŠ æ³•ç›´æ¥ä¸€æ¡çº¿ä¸Šå…¨éƒ¨åŠ ä¸Šxå³å¯
    if(l==r) return;
    int m = (l+r)>>1;
    if(p<=m) modify(l, m, sgt[k].l, p, x);      // åœ¨å·¦å­æ ‘
    else modify(m+1, r, sgt[k].r, p, x);        // åœ¨å³å­æ ‘
}
void merge(int &x,int y)        // æŠŠyç»“ç‚¹çš„å†…å®¹åˆå¹¶åˆ°xç»“ç‚¹ä¸Šï¼Œæ­¤å†™æ³•ä¸æ¶ˆè€—ç©ºé—´
{
    if(!(x&&y)) x|=y;           // å¦‚æœäºŒè€…æœ‰NULLç»“ç‚¹
    else 
    {
        sgt[x].val += sgt[y].val;   // ç»´æŠ¤åŠ æ³•ï¼Œç›´æ¥åŠ å°±æ˜¯äº†
        merge(sgt[x].l, sgt[y].l);  // é€’å½’åˆå¹¶ä¸¤ç»“ç‚¹çš„å·¦å­æ ‘
        merge(sgt[x].r, sgt[y].r);  // é€’å½’åˆå¹¶ä¸¤ç»“ç‚¹çš„å³å­æ ‘
    }
}
int split(int l,int r,int &k,int x,int y)   // ä»kä¸­åˆ†ç¦»å‡º[x,y]åŒºé—´å¹¶è¿”å›æ–°ç»“ç‚¹ç¼–å·ï¼Œç©ºé—´å¤æ‚åº¦O(2logn)
{
    int n = ++cnt;
    if(x<=l&&y>=r)      // å¦‚æœkç»“ç‚¹ç»´æŠ¤çš„åŒºé—´åœ¨[x,y]ä¸­
    {
        sgt[n] = sgt[k];    // ç›´æ¥æ‹¿è¿‡æ¥ä¾¿æ˜¯
        k = 0;              // ç½®ä¸ºNULLï¼Œæ–­æ‰è”ç³»
    }
    else 
    {
        int m = (l+r)>>1;
        if(x<=m) sgt[n].l = split(l, m, sgt[k].l, x, y);        // è‹¥å·¦å­æ ‘ä¸­æœ‰åŒºé—´ä¿¡æ¯
        if(y>m)  sgt[n].r = split(m+1, r, sgt[k].r, x, y);      // è‹¥å³å­æ ‘ä¸­æœ‰åŒºé—´ä¿¡æ¯
        pushup(k);
        pushup(n);      // æ›´æ”¹åè®°å¾—æ›´æ–°å€¼
    }
    return n;
}
ll query(int l,int r,int k,int x,int y)     // åŒºé—´æŸ¥è¯¢
{
    if(x<=l&&y>=r) return sgt[k].val;
    int m = (l+r)>>1;
    ll sum = 0;
    if(x<=m) sum += query(l,m,sgt[k].l,x,y);
    if(y>m)  sum += query(m+1,r,sgt[k].r,x,y);
    return sum;
}
ll query(int l,int r,int k,int kth)         // å•ç‚¹æŸ¥è¯¢
{
    if(l==r) return l;
    int m = (l+r)>>1;
    if(kth<=sgt[sgt[k].l].val) return query(l,m,sgt[k].l,kth);
    else return query(m+1,r,sgt[k].r,kth-sgt[sgt[k].l].val);
}
signed main(signed argc, char const *argv[])
{
    clock_t c1 = clock();
#ifdef LOCAL
    freopen("in.in", "r", stdin);
    freopen("out.out", "w", stdout);
#endif
    //======================================
    int n,m;
    cin>>n>>m;
    for(int i=1;i<=n;i++)
    {
        int x;
        cin>>x;
        modify(1,n,root[1],i,x);            // åˆå§‹çŠ¶æ€ä¸‹å€¼éƒ½ä¸º0ï¼Œæ‰€ä»¥åŠ xå³ä¸ºç½®ä¸ºx
    }
    int last = 1;
    while(m--)
    {
        int opt,x,y,z;
        cin>>opt>>x>>y;
        switch(opt)
        {
        case 0:
            cin>>z;
            root[++last] = split(1, n, root[x], y, z);
            break;
        case 1:
            merge(root[x],root[y]);
            break;
        case 2:
            cin>>z;
            modify(1,n,root[x],z,y);
            break;
        case 3:
            cin>>z;
            cout<<query(1,n,root[x],y,z)<<endl;
            break;
        case 4:
            if(y>sgt[root[x]].val) cout<<-1<<endl;      // è‹¥åªæœ‰4ä¸ªå…ƒç´ å´æ¥æŸ¥è¯¢ç¬¬5å¤§å…ƒç´ ï¼ˆä¾‹å¦‚ï¼‰ï¼Œé‚£ä¹ˆç»“æœå³ä¸º-1
            else cout<<query(1,n,root[x],y)<<endl;
            break;
        }
    }
    //======================================
end:
    cerr << "Time Used:" << clock() - c1 << "ms" << endl;
    return 0;
}
```

# åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘

[C48 çº¿æ®µæ ‘+åŠ¨æ€å¼€ç‚¹ CF915E Physical Education Lessons_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1Uh4y1i7hm/)

![[Pasted image 20240503205623.png|1224]]
![[Pasted image 20240504172239.png]]

#### æ¨¡æ¿é¢˜
[Physical Education Lessons - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/CF915E)

æ—¶é—´è¶…æ—¶ï¼Œä½†é€»è¾‘æ­£ç¡®å¯å‚è€ƒå­¦ä¹ 

```cpp
#include <iostream>
#define ll long long
#define lc tr[u].l
#define rc tr[u].r
using namespace std;
const int MAXN=3e5+5;
int tot=1;
struct node {
    int l,r,num,tag;
}tr[MAXN*50];
void pushup (int u){
    tr[u].num=tr[lc].num+tr[rc].num;
}
void pushdown (int u,int l,int r){
    if (tr[u].tag==0){
        return ;
    }
    int m=(l+r)>>1;
    //å¼€ç‚¹
    if (!tr[u].l) tr[u].l=++tot;
    if (!tr[u].r) tr[u].r=++tot;
    if (tr[u].tag==1)//éå·¥ä½œæ—¥
    {
        tr[lc].num=m-l+1;
        tr[rc].num=r-m;
    }else if (tr[u].tag==2){//å·¥ä½œæ—¥
        tr[lc].num=tr[rc].num=0;
    }
    tr[lc].tag=tr[rc].tag=tr[u].tag;
    tr[u].tag=0;
}
void change (int &u,int l,int r,int x,int y,int tag){//uå¿…é¡»ä¸ºå¼•ç”¨
	//å¼€ç‚¹
    if (!u){//å› ä¸ºæ­¤å¤„ä¼šå¯¹uä¿®æ”¹
        u=++tot;//å¦‚æœä¸æ˜¯å¼•ç”¨ï¼Œåˆ™uçš„å·¦å³å­æ ‘æ°¸è¿œæŒ‡å‘0
    }
    if (x<=l&&y>=r){
        if (tag==1){
            tr[u].num=r-l+1;
        }else {
            tr[u].num=0;
        }
        tr[u].tag=tag;
        return ;
    }
    pushdown (u,l,r);
    int m=(l+r)>>1;
    if (x<=m){
        change (lc,l,m,x,y,tag);
    }
    if (y>m){
        change (rc,m+1,r,x,y,tag);
    }
    pushup (u);

}
int main ()
{
    int n,m,root=1;
    cin>>n>>m;
    int opt,l,r;
    for (int i=1;i<=m;i++){
        cin>>l>>r>>opt;
        change (root,1,n,l,r,opt);
        cout<<n-tr[root].num<<endl;
    }
    return 0;
}
```

#### é¢˜äºŒï¼š
[T125847 ã€æ¨¡æ¿ã€‘åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/T125847)


#### é¢˜ä¸‰ï¼š
[P3960 [NOIP2017 æé«˜ç»„] åˆ—é˜Ÿ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3960)


# å¯æŒä¹…åŒ–çº¿æ®µæ ‘ï¼ˆä¸»å¸­æ ‘ï¼‰

[C49ã€æ¨¡æ¿ã€‘å¯æŒä¹…åŒ–çº¿æ®µæ ‘ï¼ˆä¸»å¸­æ ‘ï¼‰P3919 å¯æŒä¹…åŒ–æ•°ç»„_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV11H4y167rp/)

## ç†è®º
![[Pasted image 20240504172813.png]]
## å®ç°

#### å»ºæ ‘
![[Pasted image 20240504173258.png]]
#### ç‚¹ä¿®
![[Pasted image 20240504174024.png]]

#### ç‚¹æŸ¥

![[Pasted image 20240504174145.png]]

## ä»£ç å®ç°

#### ä¾‹é¢˜ï¼š
[P3919 ã€æ¨¡æ¿ã€‘å¯æŒä¹…åŒ–çº¿æ®µæ ‘ 1ï¼ˆå¯æŒä¹…åŒ–æ•°ç»„ï¼‰ - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3919)

```cpp
#include <iostream>
#define ll long long
using namespace std;
const int MAXN=1e6+5;
int root[MAXN],tot;
int a[MAXN];
struct node {
    int l,r,num;
}tr[MAXN*25];
void build (int &u,int l ,int r){//å»ºæ ‘
    u=++tot;
    if (l==r){
        tr[u].num=a[l];
        return ;
    }
    int m=(l+r)>>1;
    build (tr[u].l,l,m);
    build (tr[u].r,m+1,r);
}
void change (int &u,int v,int l,int r,int p,int num){//ç‚¹ä¿®
    u=++tot;
    tr[u]=tr[v];
    if (l==r){
        tr[u].num=num;
        return ;
    }
    int m=(l+r)>>1;
    if (p<=m){
        change(tr[u].l,tr[v].l,l,m,p,num);
    }else {
        change(tr[u].r,tr[v].r,m+1,r,p,num);
    }
    return ;
}
int query (int u,int l,int r,int p){//ç‚¹æŸ¥
   if (l==r){
       return tr[u].num;
   }
   int m=(l+r)>>1;
   if (p<=m){
      return  query(tr[u].l,l,m,p);
   }else {
      return  query (tr[u].r,m+1,r,p);
   }
}
int main ()
{
    int n,m;
    cin>>n>>m;
    for (int i=1;i<=n;i++){
        scanf ("%d",&a[i]);
//        cin>>a[i];
    }
    build (root[0],1,n);

    for (int i=1;i<=m;i++){
        int u,opt,x,num;
        scanf ("%d %d %d",&u,&opt,&x);
//        cin>>u>>opt>>x;
        if (opt==1){
            scanf ("%d",&num);
//            cin>>num;
            change (root[i],root[u],1,n,x,num);
        }else {
            root[i]=root [u];
            cout<<query(root[u],1,n,x)<<endl;
        }
    }
    return 0;
}

```


# çº¿æ®µæ ‘æ ‡è®°æ°¸ä¹…åŒ–

***æ ‡è®°æ°¸ä¹…åŒ–***ï¼šå°±æ˜¯ä¿®æ”¹æ—¶ç•™ä¸‹çš„æ‡’æ ‡è®°å¹¶ä¸ä¸‹ç©¿ï¼Œä¹Ÿä¸åˆ é™¤ï¼Œè€Œæ˜¯ç•™åœ¨æ‰“ä¸Šæ ‡è®°çš„é‚£ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚å½“æŸ¥è¯¢ç»è¿‡è¿™ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå°±åŠ ä¸Šè¿™ä¸ªèŠ‚ç‚¹çš„æ‡’æ ‡è®°é€ æˆçš„å½±å“ã€‚

***å› æ­¤***ï¼šæ ‡è®°æ°¸ä¹…åŒ–ä¸éœ€è¦ pushdownä»¥åŠpushupæ“ä½œï¼Œå¯ä»¥é¿å…ä¸€äº›ä¸å¿…è¦çš„è®¡ç®—ï¼Œæ¥èŠ‚çœæ—¶é—´

![[Pasted image 20240504220148.png]]

```cpp
#include <iostream>
#define ll long long
using namespace std;
const int MAXN=1e6+5;
int root[MAXN],tot;
int a[MAXN];
struct node {
    int l,r,num,tag;//åŒºé—´å’Œï¼Œæ°¸ä¹…æ ‡è®°
}tr[MAXN*25];
void build(int u,int l,int r){
    tr[u].num=a[l];
    if (l==r){
        return ;
    }
    //lc=u>>1;rc=lc+1;
    build (lc,l,m);
    build (rc,m+1,r);
    tr[u].num=tr[lc].num+tr[rc].num;
}
 void change (int u,int l,int r,int x,int y,ll k){//åŒºä¿®
    tr[u].num+=(min(r,y)-max(l,x)+1)*k;//ç»è¿‡èŠ‚ç‚¹æ›´æ–°num
    if (x<=l&&y>=r){//è¦†ç›–èŠ‚ç‚¹å°±æ›´æ–°tag
        tr[u].tag+=k;
        return ;
    }
    int m=(l+r)>>1;
    if (x<=m){
        change (lc,l,m,x,y,k);
    }
    if (y>m){
        change (rc,m+1,r,x,y,k);
    }
}
 ll query(int u,int l,int r,int x,int y,ll s){//åŒºæŸ¥ï¼Œsè·¯å¾„ä¸Štagçš„ç´¯è®¡
    if (x<=l&&y>=r){//è¦†ç›–å°±è¿”å›
        return tr[u].num+(min (r,y)-max (x,l)+1)*s;
    }
    ll res=0;
    s+=tr[u].tag;//ç´¯è®¡tagï¼Œå„¿å­è¦ç”¨
    int m=(r+l)>>1;
    if (x<=m){
        res+=query (lc,l,r,x,y,s);
    }
    if (y>m){
        res+= query(rc,l,r,x,y,s);
    }
    return res;
}
```

# çº¿æ®µæ ‘ç»´æŠ¤çŸ©é˜µä¹˜æ³•

çŸ©é˜µä¹˜æ³•æ»¡è¶³
	ç»“åˆå¾‹ï¼š(A\*B)\*C=A\*(B\*C)
	åˆ†é…å¾‹ï¼šA\*(B+C)=A\*B+A\*C

[çº¿æ®µæ ‘ç»´æŠ¤çŸ©é˜µ - untitled0 - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/untitled0/p/sgt-matrix.html)

# çº¿æ®µæ ‘ç»´æŠ¤å“ˆå¸Œ

[çº¿æ®µæ ‘ç»´æŠ¤å“ˆå¸Œ - zltzlt - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/zltzlt-blog/p/16797435.html)
