
# 静态库和共享库对比
1. 静态库在文件中静态展开，**==所以有多少文件就展开多少次，非常吃内存==**，100M展开100次，就是1G，但是这样的好处就是静态加载的速度快 ，**==可移植性强，可以独立运行==**
2. 使用动态库会将动态库加载到内存，**==10个文件也只需要加载一次==**，然后这些文件用到库的时候临时去加载，速度慢一些，但是很省内存

# 制作静态库
### 准备静态库文件
在.cpp文件当中只写入相应的函数即可，不需要头文件，主函数等等
```
int add (int a,int b){
    return a+b;
}
```
![[Pasted image 20240704191648.png]]

### 生成静态库
1. 将 .c 生成 .o 文件  
```
g++  -c add.c -o add.o  
```
2. 使用 ar 工具制作静态库  
```
ar rcs lib库名.a add.o sub.o div.o  
```
![[Pasted image 20240704193459.png|1128]]

### 编译静态库到可执行文件中：  
**==测试文件==**
```cpp
//hello.cpp
#include "hello.h"

#define HELLO
#ifdef HELLO 
    #define  GDB true
#endif

using namespace std;


int main()
{
    if (GDB){
        cout << "Hello Linux" << endl;
    }
    int a=10,b=20;
    cout<<add(a,b)<<endl;
    cout<<sub(a,b)<<endl;
    cout<<div1(a,b)<<endl;
    
    return 0;
}
//hello.h
#ifndef _HELLO_H_
#define HELLO_H_
#include <iostream>
#include <cstring>
#include <cmath>
#include <algorithm>
#include <queue>
int add (int a,int b);
int sub (int a,int b);
double div1(double a,double b);
#endif
```

**==编译命令==**
```
g++  test.c lib库名.a -o a.out
```
![[Pasted image 20240704195237.png]]


### 当库和源码不在同一个文件夹时
```
g++ hello.cpp ./lib/libmylib.a -o hello -I ./inc
```

![[Pasted image 20240704201220.png]]


# 动态库
1. 写在源代码里的函数，相对main函数偏移是一定的，链接时，回填main函数地址之后，其他源代码里的函数也就得到了地址。  
2. 动态库里的函数会用一个@plt来标识，当动态库加载到内存时，再用加载进去的地址将@plt替换掉。


### 制作动态库的步骤  
1. 生成位置无关的.o文件  （生成与位置无关的代码，-fPIC）
```
g++ -c add.c -o add.o -fPIC  
```
使用这个参数过后，生成的函数就和位置无关，挂上@plt标识，等待动态绑定  
2. 使用 gcc -shared制作动态库  
```
g++ -shared -o lib库名.so add.o sub.o div1.o  
```
3. 编译可执行程序时指定所使用的动态库。***-l:指定库名 -L:指定库路径***  
```
g++ hello.cpp -o hello -l mymath -L ./lib  
```

### 动态链接器
1. 连接器： 工作于链接阶段，工作时需要 -l 和 -L  
2. 动态链接器： 工作于程序运行阶段，工作时需要提供动态库所在目录位置
### 解决方式 

###### 方法一：
通过环境变量： export LD_LIBRARY_PATH=动态库路径  
./a.out 成功！！！ （临时生效， 终端重启环境变量失效）  
###### 方法二：
永久生效： 写入 终端配置文件。 .bashrc 建议使用绝对路径。  
1) vim ~/.bashrc  
2) 写入 export LD_LIBRARY_PATH=动态库路径 保存 
3) ..bashrc/ source .bashrc / 重启 终端 ---> 让修改后的.bashrc生效  
4) ./a.out 成功！！！  

###### 方法三：
拷贝自定义动态库 到 /lib (标准C库所在目录位置)  
###### 方法四：配置文件法  
1. sudo vim /etc/ld.so.conf  
2. 写入 动态库绝对路径 保存  
3. sudo ldconfig -v 使配置文件生效。  
4. ./a.out 成功！！！--- 使用 ldd a.out 查看

### 运行程序
```
./hello 
```

# 数据段合并和地址回填

### 地址回填
![[Pasted image 20240704214943.png]]


### 数据段合并

![[Pasted image 20240704220132.png]]
